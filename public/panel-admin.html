<!DOCTYPE html>
<html lang="id" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        body { display: flex; }
        .sidebar { position: fixed; top: 0; bottom: 0; left: 0; z-index: 100; width: 250px; background-color: var(--bg-secondary-color); border-right: 1px solid var(--border-color); }
        .sidebar .nav-link { color: var(--text-secondary-color); font-weight: 600; padding: .75rem 1rem; }
        .sidebar .nav-link:hover { color: var(--text-color); }
        .sidebar .nav-link.active { color: var(--text-header-color); background-color: var(--hover-color); border-radius: var(--border-radius);}
        .main-content-admin { width: 100%; }
        .admin-header { display: none; }
        .table-stack-on-mobile th { white-space: nowrap; }

        @media (max-width: 991.98px) {
            .sidebar.d-lg-block { display: none !important; }
            .admin-header { display: flex; align-items: center; padding: .5rem 1rem; background-color: var(--bg-secondary-color); border-bottom: 1px solid var(--border-color); }
            .main-content-admin { padding-left: 0; }
        }
    </style>
</head>
<body>
    <div id="admin-app" class="w-100">
        <aside class="sidebar p-3 d-none d-lg-block">
            <h4 class="text-white fw-bold mb-4"><i class="bi bi-box-fill me-2"></i>Admin Panel</h4>
            <ul class="nav flex-column">
                <li class="nav-item mb-2"><a href="#" @click.prevent="view = 'dashboard'" class="nav-link" :class="{active: view === 'dashboard'}"><i class="bi bi-grid-1x2-fill me-2"></i>Dashboard</a></li>
                <li class="nav-item mb-2"><a href="#" @click.prevent="view = 'users'" class="nav-link" :class="{active: view === 'users'}"><i class="bi bi-people-fill me-2"></i>Pengguna</a></li>
                <li class="nav-item mb-2"><a href="#" @click.prevent="view = 'transactions'" class="nav-link" :class="{active: view === 'transactions'}"><i class="bi bi-receipt me-2"></i>Transaksi</a></li>
                <li class="nav-item mb-2"><a href="#" @click.prevent="view = 'apiLogs'" class="nav-link" :class="{active: view === 'apiLogs'}"><i class="bi bi-activity me-2"></i>Log API</a></li>
                <li class="nav-item mb-2"><a href="#" @click.prevent="view = 'settings'" class="nav-link" :class="{active: view === 'settings'}"><i class="bi bi-gear-fill me-2"></i>Pengaturan</a></li>
            </ul>
        </aside>

        <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="sidebarMenu">
             <div class="offcanvas-header">
                <h5 class="offcanvas-title fw-bold"><i class="bi bi-box-fill me-2"></i>Admin Panel</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
            </div>
            <div class="offcanvas-body">
                <ul class="nav flex-column">
                     <li class="nav-item mb-2"><a href="#" @click.prevent="view = 'dashboard'" class="nav-link" :class="{active: view === 'dashboard'}" data-bs-dismiss="offcanvas"><i class="bi bi-grid-1x2-fill me-2"></i>Dashboard</a></li>
                     <li class="nav-item mb-2"><a href="#" @click.prevent="view = 'users'" class="nav-link" :class="{active: view === 'users'}" data-bs-dismiss="offcanvas"><i class="bi bi-people-fill me-2"></i>Pengguna</a></li>
                     <li class="nav-item mb-2"><a href="#" @click.prevent="view = 'transactions'" class="nav-link" :class="{active: view === 'transactions'}" data-bs-dismiss="offcanvas"><i class="bi bi-receipt me-2"></i>Transaksi</a></li>
                     <li class="nav-item mb-2"><a href="#" @click.prevent="view = 'apiLogs'" class="nav-link" :class="{active: view === 'apiLogs'}" data-bs-dismiss="offcanvas"><i class="bi bi-activity me-2"></i>Log API</a></li>
                     <li class="nav-item mb-2"><a href="#" @click.prevent="view = 'settings'" class="nav-link" :class="{active: view === 'settings'}" data-bs-dismiss="offcanvas"><i class="bi bi-gear-fill me-2"></i>Pengaturan</a></li>
                </ul>
            </div>
        </div>

        <main class="main-content-admin">
            <header class="admin-header">
                <button class="btn btn-dark" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu">
                    <i class="bi bi-list"></i>
                </button>
                <h5 class="ms-3 mb-0 text-white">Admin Panel</h5>
            </header>
            <div class="p-4">
                <div v-if="view === 'dashboard'">
                    <h2 class="main-title mb-4">Dashboard</h2>
                    <div class="row g-4">
                        <div class="col-lg-4 col-md-6"><div class="card card-body text-center h-100"><h6 class="text-secondary">Total Pengguna</h6><h3 class="fw-bold">{{ stats.totalUsers }}</h3></div></div>
                        <div class="col-lg-4 col-md-6"><div class="card card-body text-center h-100"><h6 class="text-secondary">Total Pendapatan (Completed)</h6><h3 class="fw-bold">Rp{{ stats.totalRevenue?.toLocaleString('id-ID') }}</h3></div></div>
                        <div class="col-lg-4 col-md-6"><div class="card card-body text-center h-100"><h6 class="text-secondary">Total Saldo Pengguna</h6><h3 class="fw-bold">Rp{{ stats.totalUserBalance?.toLocaleString('id-ID') }}</h3></div></div>
                    </div>
                </div>

                <div v-if="view === 'users'">
                    <h2 class="main-title mb-4">Manajemen Pengguna</h2>
                    <div class="card">
                        <div class="card-header d-flex flex-wrap gap-2 justify-content-between align-items-center">
                            <input type="text" class="form-control" style="max-width: 300px;" v-model="userSearchTerm" @input="fetchUsers" placeholder="Cari username atau email...">
                            <div>
                                <button class="btn btn-danger btn-sm" @click="deleteSelectedUsers" :disabled="selectedUserIds.length === 0"><i class="bi bi-trash-fill me-1"></i>Hapus Terpilih</button>
                                <button class="btn btn-danger btn-sm" @click="deleteAllUsers"><i class="bi bi-exclamation-triangle-fill me-1"></i>Hapus Semua</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-stack-on-mobile mb-0">
                                <thead><tr>
                                    <th><input type="checkbox" class="form-check-input" @change="toggleSelectAllUsers"></th>
                                    <th>Username</th><th>Email</th><th>Saldo</th><th>Status</th><th>Peran</th><th>Aksi</th>
                                </tr></thead>
                                <tbody><tr v-for="user in users" :key="user._id">
                                    <td data-label="Pilih"><input type="checkbox" class="form-check-input" :value="user._id" v-model="selectedUserIds"></td>
                                    <td data-label="Username"><strong>{{ user.username }}</strong></td>
                                    <td data-label="Email">{{ user.email }}</td>
                                    <td data-label="Saldo">Rp{{ user.balance.toLocaleString('id-ID') }}</td>
                                    <td data-label="Status"><span class="badge" :class="user.isActive ? 'bg-success' : 'bg-danger'">{{ user.isActive ? 'Aktif' : 'Nonaktif' }}</span></td>
                                    <td data-label="Peran"><span class="badge bg-primary">{{ user.role }}</span></td>
                                    <td data-label="Aksi"><button class="btn btn-sm btn-outline-light" @click="viewUserDetails(user)">Detail</button></td>
                                </tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div v-if="view === 'transactions'">
                    <h2 class="main-title mb-4">Riwayat Transaksi</h2>
                    <div class="card">
                         <div class="card-header d-flex flex-wrap gap-2 justify-content-between align-items-center">
                            <select class="form-select" style="max-width: 200px;" v-model="transactionStatusFilter" @change="fetchTransactions">
                                <option value="semua">Semua Status</option>
                                <option value="completed">Completed</option>
                                <option value="pending">Pending</option>
                                <option value="expired">Expired</option>
                            </select>
                            <div>
                                <button class="btn btn-danger btn-sm" @click="deleteSelectedTransactions" :disabled="selectedTransactionIds.length === 0"><i class="bi bi-trash-fill me-1"></i>Hapus Terpilih</button>
                                <button class="btn btn-danger btn-sm" @click="deleteAllTransactions"><i class="bi bi-exclamation-triangle-fill me-1"></i>Hapus Semua</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-stack-on-mobile mb-0">
                                <thead><tr>
                                    <th><input type="checkbox" class="form-check-input" @change="toggleSelectAllTransactions"></th>
                                    <th>Tanggal</th><th>Pengguna</th><th>Jumlah</th><th>Status</th>
                                </tr></thead>
                                <tbody><tr v-for="trx in transactions" :key="trx._id">
                                    <td data-label="Pilih"><input type="checkbox" class="form-check-input" :value="trx._id" v-model="selectedTransactionIds"></td>
                                    <td data-label="Tanggal">{{ new Date(trx.createdAt).toLocaleString('id-ID') }}</td>
                                    <td data-label="Pengguna">{{ trx.user ? trx.user.username : 'N/A' }}</td>
                                    <td data-label="Jumlah">Rp{{ trx.uniqueAmount.toLocaleString('id-ID') }}</td>
                                    <td data-label="Status"><span class="badge" :class="{'bg-success': trx.status === 'completed', 'bg-warning text-dark': trx.status === 'pending', 'bg-danger': trx.status === 'expired'}">{{ trx.status }}</span></td>
                                </tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div v-if="view === 'apiLogs'">
                    <h2 class="main-title mb-4">Log Penggunaan API</h2>
                     <div class="card">
                        <div class="table-responsive">
                            <table class="table table-stack-on-mobile mb-0">
                                <thead><tr><th>Waktu</th><th>Pengguna</th><th>API Key</th><th>Endpoint</th><th>IP</th><th>Status</th></tr></thead>
                                <tbody><tr v-for="log in apiLogs" :key="log._id">
                                    <td data-label="Waktu">{{ new Date(log.timestamp).toLocaleString('id-ID') }}</td>
                                    <td data-label="Pengguna">{{ log.userId ? log.userId.username : 'N/A' }}</td>
                                    <td data-label="API Key"><code>{{ log.apiKey }}</code></td>
                                    <td data-label="Endpoint">{{ log.method }} {{ log.endpoint }}</td>
                                    <td data-label="IP">{{ log.ipAddress }}</td>
                                    <td data-label="Status"><span class="badge" :class="log.success ? 'bg-success' : 'bg-danger'">{{ log.statusCode }}</span></td>
                                </tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div v-if="view === 'settings'">
                     <h2 class="main-title mb-4">Pengaturan Situs</h2>
                     <div class="row">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-body">
                                    <form @submit.prevent="saveSettings">
                                        <div class="mb-3">
                                            <label class="form-label">Harga API Key (Rp)</label>
                                            <input type="number" class="form-control" v-model.number="settings.API_KEY_PRICE">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Durasi API Key (Hari)</label>
                                            <input type="number" class="form-control" v-model.number="settings.API_KEY_DURATION_DAYS">
                                        </div>
                                        <button type="submit" class="btn btn-primary">Simpan Pengaturan</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                     </div>
                </div>
            
                <div v-if="selectedUser" class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);">
                    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Detail Pengguna: {{ selectedUser.username }}</h5>
                                <button type="button" class="btn-close" @click="selectedUser = null"></button>
                            </div>
                            <div class="modal-body">
                                <ul class="nav nav-tabs">
                                    <li class="nav-item"><a class="nav-link" :class="{active: modalView === 'edit'}" href="#" @click.prevent="modalView = 'edit'">Edit Info</a></li>
                                    <li class="nav-item"><a class="nav-link" :class="{active: modalView === 'keys'}" href="#" @click.prevent="modalView = 'keys'">API Keys</a></li>
                                    <li class="nav-item"><a class="nav-link" :class="{active: modalView === 'transactions'}" href="#" @click.prevent="modalView = 'transactions'">Transaksi</a></li>
                                    <li class="nav-item"><a class="nav-link" :class="{active: modalView === 'callback'}" href="#" @click.prevent="modalView = 'callback'">Callback</a></li>
                                </ul>
                                <div class="tab-content pt-3">
                                    <div v-if="modalView === 'edit'">
                                        <div class="mb-3"><label class="form-label">Username</label><input type="text" class="form-control" v-model="form.username"></div>
                                        <div class="mb-3"><label class="form-label">Email</label><input type="email" class="form-control" v-model="form.email"></div>
                                        <div class="mb-3"><label class="form-label">Saldo</label><input type="number" class="form-control" v-model.number="form.balance"></div>
                                        <div class="mb-3"><label class="form-label">Peran</label><select class="form-select" v-model="form.role"><option value="user">User</option><option value="admin">Admin</option></select></div>
                                        <div class="form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" v-model="form.isActive" id="isActiveSwitch"><label class="form-check-label" for="isActiveSwitch">Akun Aktif</label></div>
                                    </div>
                                    <div v-if="modalView === 'keys'">
                                        <div v-if="!detailedUserData.user.apiKeys || detailedUserData.user.apiKeys.length === 0" class="text-center text-secondary">Pengguna ini tidak memiliki API Key.</div>
                                        <ul v-else class="list-group">
                                            <li v-for="key in detailedUserData.user.apiKeys" class="list-group-item">
                                                <strong>{{ key.name }}</strong><br>
                                                <small class="text-secondary">{{ key.key }}</small><br>
                                                <small>Kadaluarsa: {{ new Date(key.expiresAt).toLocaleDateString('id-ID') }}</small>
                                            </li>
                                        </ul>
                                    </div>
                                    <div v-if="modalView === 'transactions'">
                                        <div v-if="!detailedUserData.transactions || detailedUserData.transactions.length === 0" class="text-center text-secondary">Pengguna ini tidak memiliki riwayat transaksi.</div>
                                        <table v-else class="table table-sm">
                                            <thead><tr><th>Tanggal</th><th>Jumlah</th><th>Status</th></tr></thead>
                                            <tbody><tr v-for="trx in detailedUserData.transactions">
                                                <td>{{ new Date(trx.createdAt).toLocaleString('id-ID') }}</td>
                                                <td>Rp{{ trx.uniqueAmount.toLocaleString('id-ID') }}</td>
                                                <td><span class="badge" :class="{'bg-success': trx.status === 'completed', 'bg-warning text-dark': trx.status === 'pending', 'bg-danger': trx.status === 'expired'}">{{ trx.status }}</span></td>
                                            </tr></tbody>
                                        </table>
                                    </div>
                                    <div v-if="modalView === 'callback'">
                                        <p><strong>Status:</strong> {{ detailedUserData.user.callbackSettings.isActive ? 'Aktif' : 'Nonaktif' }}</p>
                                        <p><strong>Username Mutasi:</strong> {{ detailedUserData.user.callbackSettings.mutasiAuthUsername || '-' }}</p>
                                        <p><strong>Webhook URL:</strong> {{ detailedUserData.user.callbackSettings.webhookUrl || '-' }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" @click="selectedUser = null">Tutup</button>
                                <button v-if="modalView === 'edit'" type="button" class="btn btn-primary" @click="saveUser">Simpan Perubahan</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script src="https://unpkg.com/vue@3"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const { createApp } = Vue;
    createApp({
        data() {
            return {
                view: 'dashboard',
                stats: {},
                users: [],
                transactions: [],
                apiLogs: [],
                settings: { API_KEY_PRICE: 0, API_KEY_DURATION_DAYS: 0 },
                userSearchTerm: '',
                transactionStatusFilter: 'semua',
                selectedUserIds: [],
                selectedTransactionIds: [],
                selectedUser: null,
                detailedUserData: { user: {}, transactions: [] },
                modalView: 'edit',
                form: {}
            }
        },
        methods: {
            async fetchStats() {
                const res = await fetch('/api/admin/stats');
                const data = await res.json();
                if (data.success) this.stats = data.stats;
            },
            async fetchUsers() {
                const res = await fetch(`/api/admin/users?search=${this.userSearchTerm}`);
                const data = await res.json();
                if (data.success) this.users = data.users;
            },
            async fetchTransactions() {
                const res = await fetch(`/api/admin/transactions?status=${this.transactionStatusFilter}`);
                const data = await res.json();
                if (data.success) this.transactions = data.transactions;
            },
            async fetchApiLogs() {
                const res = await fetch('/api/admin/api-logs');
                const data = await res.json();
                if(data.success) this.apiLogs = data.logs;
            },
            async fetchSettings() {
                const res = await fetch('/api/admin/settings');
                const data = await res.json();
                if (data.success) {
                    this.settings = {
                        API_KEY_PRICE: data.settings.API_KEY_PRICE || 50000,
                        API_KEY_DURATION_DAYS: data.settings.API_KEY_DURATION_DAYS || 30
                    };
                }
            },
            async saveSettings() {
                const res = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ settings: this.settings })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Pengaturan berhasil disimpan!');
                } else {
                    alert('Gagal menyimpan: ' + data.message);
                }
            },
            async viewUserDetails(user) {
                this.selectedUser = user;
                this.modalView = 'edit';
                this.form = { ...user };
                const res = await fetch(`/api/admin/users/${user._id}`);
                const data = await res.json();
                if (data.success) {
                    this.detailedUserData = data;
                }
            },
            async saveUser() {
                const res = await fetch(`/api/admin/users/${this.selectedUser._id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.form)
                });
                const data = await res.json();
                if (data.success) {
                    this.fetchUsers();
                    this.selectedUser = null;
                } else {
                    alert(data.message);
                }
            },
            toggleSelectAllUsers(event) {
                if (event.target.checked) {
                    this.selectedUserIds = this.users.map(u => u._id);
                } else {
                    this.selectedUserIds = [];
                }
            },
            async deleteSelectedUsers() {
                if (confirm(`Kamu yakin ingin menghapus ${this.selectedUserIds.length} pengguna terpilih secara permanen?`)) {
                    const res = await fetch('/api/admin/users', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: this.selectedUserIds })
                    });
                    const data = await res.json();
                    alert(data.message);
                    if(data.success) {
                        this.selectedUserIds = [];
                        this.fetchUsers();
                    }
                }
            },
            async deleteAllUsers() {
                if (confirm('PERINGATAN: Kamu yakin ingin menghapus SEMUA pengguna? Aksi ini tidak dapat dibatalkan.')) {
                    const allUserIds = this.users.map(u => u._id);
                     const res = await fetch('/api/admin/users', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: allUserIds })
                    });
                    const data = await res.json();
                    alert(data.message);
                    if(data.success) {
                        this.selectedUserIds = [];
                        this.fetchUsers();
                    }
                }
            },
            toggleSelectAllTransactions(event) {
                if (event.target.checked) {
                    this.selectedTransactionIds = this.transactions.map(t => t._id);
                } else {
                    this.selectedTransactionIds = [];
                }
            },
            async deleteSelectedTransactions() {
                if (confirm(`Kamu yakin ingin menghapus ${this.selectedTransactionIds.length} transaksi terpilih secara permanen?`)) {
                    const res = await fetch('/api/admin/transactions', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: this.selectedTransactionIds })
                    });
                    const data = await res.json();
                    alert(data.message);
                    if(data.success) {
                        this.selectedTransactionIds = [];
                        this.fetchTransactions();
                    }
                }
            },
             async deleteAllTransactions() {
                if (confirm('PERINGATAN: Kamu yakin ingin menghapus SEMUA transaksi? Aksi ini tidak dapat dibatalkan.')) {
                    const allTransactionIds = this.transactions.map(t => t._id);
                     const res = await fetch('/api/admin/transactions', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: allTransactionIds })
                    });
                    const data = await res.json();
                    alert(data.message);
                    if(data.success) {
                        this.selectedTransactionIds = [];
                        this.fetchTransactions();
                    }
                }
            }
        },
        watch: {
            view(newView) {
                if (newView === 'dashboard') this.fetchStats();
                if (newView === 'users') this.fetchUsers();
                if (newView === 'transactions') this.fetchTransactions();
                if (newView === 'apiLogs') this.fetchApiLogs();
                if (newView === 'settings') this.fetchSettings();
            }
        },
        mounted() {
            this.fetchStats();
        }
    }).mount('#admin-app');
</script>
</body>
</html>
